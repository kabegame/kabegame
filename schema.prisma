// ============================================
// Database Schema Documentation
// ============================================
// This file is used ONLY to document the database schema structure.
// It does NOT provide any functionality and should NOT be used to generate Prisma client.
// The actual database operations are handled by SQLite in storage.rs
//
// Database: SQLite
// Location: {app_data_dir}/images.db
//
// ============================================

generator client {
    provider = "prisma-client-js"
    output   = "./prisma-client"
}

datasource db {
    provider = "sqlite"
}

// 任务表
model Task {
    id               String  @id
    pluginId         String  @map("plugin_id")
    outputDir        String? @map("output_dir")
    userConfig       String? @map("user_config") // JSON string
    status           String
    progress         Float   @default(0)
    deletedCount     Int     @default(0) @map("deleted_count")
    startTime        Int?    @map("start_time")
    endTime          Int?    @map("end_time")
    error            String?

    images           Image[]        @relation("TaskToImage")
    taskImages       TaskImage[]

    @@index([startTime(sort: Desc)], name: "idx_tasks_start_time")
    @@map("tasks")
}

// 运行配置表
model RunConfig {
    id          String  @id
    name        String
    description String?
    pluginId    String  @map("plugin_id")
    url         String
    outputDir   String? @map("output_dir")
    userConfig  String? @map("user_config") // JSON string
    createdAt   Int     @map("created_at")

    @@map("run_configs")
}

// 图片表
model Image {
    id            Int     @id @default(autoincrement())
    url           String
    localPath     String  @map("local_path")
    pluginId      String  @map("plugin_id")
    taskId        String? @map("task_id")
    crawledAt     Int     @map("crawled_at")
    metadata      String? // JSON string
    thumbnailPath String  @default("") @map("thumbnail_path")
    hash          String  @default("")
    order         Int?    @map("order")

    task          Task?        @relation("TaskToImage", fields: [taskId], references: [id], onDelete: SetNull)
    albumImages   AlbumImage[]
    taskImages    TaskImage[]

    @@index([crawledAt(sort: Desc)], name: "idx_crawled_at")
    @@index([pluginId], name: "idx_plugin_id")
    @@index([taskId], name: "idx_task_id")
    @@index([hash], name: "idx_images_hash")
    @@map("images")
}

// 画册表
model Album {
    id        String @id
    name      String
    createdAt Int    @map("created_at")
    order     Int?   @map("order")

    albumImages AlbumImage[]

    @@map("albums")
}

// 画册-图片关联表
model AlbumImage {
    albumId String @map("album_id")
    imageId Int    @map("image_id")
    order   Int?   @map("order")

    album Album @relation(fields: [albumId], references: [id], onDelete: Cascade)
    image Image @relation(fields: [imageId], references: [id], onDelete: Cascade)

    @@id([albumId, imageId])
    @@index([albumId], name: "idx_album_images_album")
    @@map("album_images")
}

// 任务-图片关联表
model TaskImage {
    taskId  String @map("task_id")
    imageId Int    @map("image_id")
    addedAt Int    @map("added_at")
    order   Int?   @map("order")

    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
    image Image @relation(fields: [imageId], references: [id], onDelete: Cascade)

    @@id([taskId, imageId])
    @@index([taskId], name: "idx_task_images_task")
    @@index([imageId], name: "idx_task_images_image")
    @@map("task_images")
}

// 临时文件表
model TempFile {
    path      String @id
    createdAt Int    @map("created_at")

    @@map("temp_files")
}