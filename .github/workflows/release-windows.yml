name: Build and Release Windows Installer

on:
  push:
    branches:
      - main # å½“æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
    tags:
      - "v*" # å½“æŽ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘
  workflow_dispatch:
    inputs:
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  build-and-release:
    name: Build Windows Installer (${{ matrix.mode }})
    strategy:
      fail-fast: false
      matrix:
        mode: [normal, local]
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true # æ£€å‡º git å­æ¨¡å—ï¼ˆsrc-crawler-pluginsï¼‰

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          cache-on-failure: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Package plugins
        id: package-plugins
        shell: pwsh
        run: |
          # æ”¹ä¸ºç›´æŽ¥ä½¿ç”¨ä»“åº“ä¸­å·²æäº¤çš„ src-crawler-plugins/packed äº§ç‰©ï¼Œä¸åœ¨ CI å†…é‡æ–°æ‰“åŒ…æ’ä»¶
          $packedDir = "src-crawler-plugins/packed"
          # æ³¨æ„ï¼šTauri app-main çš„ bundle.resources é…ç½®ä¸º resources/pluginsï¼ˆç›¸å¯¹ app-mainï¼‰
          $dstDir = "src-tauri/app-main/resources/plugins"

          if (-not (Test-Path $packedDir)) {
            throw "packed ç›®å½•ä¸å­˜åœ¨ï¼š$packedDirï¼ˆè¯·å…ˆåœ¨ä»“åº“ä¸­æäº¤ src-crawler-plugins/packedï¼‰"
          }

          New-Item -ItemType Directory -Force -Path $dstDir | Out-Null
          # æ¸…ç©ºæ—§æ’ä»¶ï¼Œé¿å…æ®‹ç•™
          Get-ChildItem -Path $dstDir -Filter *.kgpg -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue

          if ("${{ matrix.mode }}" -eq "local") {
            # local æ¨¡å¼ï¼šæ‰“åŒ…æ‰€æœ‰æ’ä»¶ï¼ˆå†…ç½®æ’ä»¶åˆ—è¡¨=resources/plugins ä¸‹çš„æ‰€æœ‰ .kgpgï¼‰
            Copy-Item -Path (Join-Path $packedDir "*.kgpg") -Destination $dstDir -Force

            $plugins = Get-ChildItem -Path $dstDir -Filter *.kgpg |
              ForEach-Object { $_.BaseName } |
              Sort-Object
            $pluginsCsv = ($plugins -join ",")
            if ($pluginsCsv) {
              "builtin_plugins=$pluginsCsv" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
              Write-Host "Builtin plugins: $pluginsCsv"
            }
          }
          else {
            # normal æ¨¡å¼ï¼šä»…æ‰“åŒ…æœ¬åœ°æ’ä»¶ï¼ˆlocal-importï¼‰
            $src = Join-Path $packedDir "local-import.kgpg"
            if (-not (Test-Path $src)) {
              throw "normal æ¨¡å¼éœ€è¦ local-import.kgpgï¼Œä½†æœªæ‰¾åˆ°ï¼š$src"
            }
            Copy-Item -Path $src -Destination $dstDir -Force
          }

      - name: Prepare Dokan runtime (dokan2.dll)
        shell: pwsh
        run: |
          $dstDir = "src-tauri/app-main/resources/bin"
          $dst = Join-Path $dstDir "dokan2.dll"
          New-Item -ItemType Directory -Force -Path $dstDir | Out-Null

          if (Test-Path $dst) {
            Write-Host "dokan2.dll already staged: $dst"
            exit 0
          }

          # 0) Prefer repo-bundled Dokan runtime DLL (checked into repo)
          $repoDll = "bin/dokan2.dll"
          if (Test-Path $repoDll) {
            Copy-Item -Path $repoDll -Destination $dst -Force
            Write-Host "Staged dokan2.dll from repo: $repoDll -> $dst"
            exit 0
          }

          function Find-Dokan2Dll() {
            $candidates = @(
              (Join-Path $env:WINDIR "System32\\dokan2.dll"),
              (Join-Path $env:WINDIR "SysWOW64\\dokan2.dll")
            )
            foreach ($p in $candidates) {
              if (Test-Path $p) { return $p }
            }
            $pf = $env:ProgramFiles
            if ($pf) {
              $root = Join-Path $pf "Dokan"
              if (Test-Path $root) {
                $hit = Get-ChildItem -Path $root -Recurse -Filter "dokan2.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
                if ($hit) { return $hit.FullName }
              }
            }
            return $null
          }

          $dll = Find-Dokan2Dll
          if (-not $dll) {
            throw "dokan2.dll not found on runner. Please commit bin/dokan2.dll (recommended) or preinstall Dokan runtime on runner."
          }

          Copy-Item -Path $dll -Destination $dst -Force
          Write-Host "Staged dokan2.dll: $dst (from: $dll)"

      - name: Get version from package.json
        id: version
        shell: bash
        run: |
          if [ -f "package.json" ]; then
            VERSION=$(node -p "require('./package.json').version")
          elif [ -f "src-tauri/Cargo.toml" ]; then
            VERSION=$(grep -m1 '^version\s*=' src-tauri/Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          else
            echo "Error: Could not find package.json or Cargo.toml"
            exit 1
          fi
          TAG="v${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG}"

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          {
            echo "changelog<<EOF"
            echo "## ðŸ“ ã‚¢ãƒ—ãƒ‡å†…å®¹"
            echo ""
            if [ -z "$CHANGES" ]; then
              echo "- æ— å˜æ›´è®°å½•"
            else
              echo "$CHANGES"
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Update productName for filename
        shell: bash
        run: |
          # ä¸´æ—¶ä¿®æ”¹ tauri.conf.json çš„ productNameï¼Œä½¿æ–‡ä»¶ååŒ…å« mode
          node -e "
          const fs = require('fs');
          const path = require('path');
          // Tauri 2 å¤š appï¼šmain çš„é…ç½®åœ¨ src-tauri/app-main/tauri.conf.json
          const configPath = 'src-tauri/app-main/tauri.conf.json';
          const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
          const originalName = config.productName;
          config.productName = originalName + '-${{ matrix.mode }}';
          fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
          console.log('Updated productName to:', config.productName);
          "

      - name: Build Tauri app
        env:
          KABEGAME_MODE: ${{ matrix.mode }}
          VITE_KABEGAME_MODE: ${{ matrix.mode }}
          KABEGAME_BUILTIN_PLUGINS: ${{ steps.package-plugins.outputs.builtin_plugins }}
          # CI å·²åœ¨ä¸Šä¸€æ­¥æŠŠ src-crawler-plugins/packed å¤åˆ¶åˆ° resources/pluginsï¼Œè¿™é‡Œä¸å†é‡å¤æ‰“åŒ…æ’ä»¶
          KABEGAME_SKIP_PLUGINS_PACKAGING: "1"
        run: pnpm build --mode ${{ matrix.mode }}

      - name: Restore productName
        if: always()
        shell: bash
        run: |
          # æ¢å¤åŽŸå§‹ productName
          node -e "
          const fs = require('fs');
          const path = require('path');
          const configPath = 'src-tauri/app-main/tauri.conf.json';
          const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
          config.productName = config.productName.replace(/-normal$|-local$/, '');
          fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
          console.log('Restored productName to:', config.productName);
          "

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: installer-${{ matrix.mode }}
          path: src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 7

  create-release:
    name: Create Release
    needs: build-and-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          TAG="v${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          {
            echo "changelog<<EOF"
            echo "## ðŸ“ æ›´æ–°å†…å®¹"
            echo ""
            if [ -z "$CHANGES" ]; then
              echo "- æ— å˜æ›´è®°å½•"
            else
              echo "$CHANGES"
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Kabegame ${{ steps.version.outputs.tag }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || contains(steps.version.outputs.version, '-') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            artifacts/installer-normal/*.exe
            artifacts/installer-local/*.exe
